rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isCreatorOwner(creatorId) {
      return isAuthenticated() && request.auth.uid == creatorId;
    }
    
    // Usuários
    match /users/{userId} {
      allow read: if isAuthenticated() || request.auth == null;
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update, delete: if isOwner(userId);
    }
    
    match /creators/{creatorId} {
      allow read: if true; // Público para compartilhamento de perfil e navegação
      allow create: if isAuthenticated() && request.auth.uid == creatorId;
      allow update, delete: if isCreatorOwner(creatorId);
    }
    
    // Profiles (perfis especiais)
    match /profiles/{profileId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Posts
    match /posts/{postId} {
      allow read: if true; // Permitir leitura pública para visualizar posts
      allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'retweets', 'comments', 'views']))
      );
      allow delete: if isAuthenticated() && resource.data.authorId == request.auth.uid;
    }
    
    // Comentários
    match /comments/{commentId} {
      allow read: if true; // Permitir leitura pública
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Likes
    match /likes/{likeId} {
      allow read: if true; // Permitir contar likes publicamente
      allow create, delete: if isAuthenticated();
    }
    
    // Retweets
    match /retweets/{retweetId} {
      allow read: if true; // Permitir contar retweets publicamente
      allow create, delete: if isAuthenticated();
    }
    
    // Notificações
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Mensagens do chat
    match /chatMessages/{messageId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Gorjetas (tips)
    match /tips/{tipId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Transações
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.creatorId);
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // Rede de criadoras (MLM)
    match /creator_network/{networkId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        (request.auth.uid == resource.data.creatorId || 
         request.auth.uid == resource.data.referredBy);
    }
    
    match /referral_codes/{codeId} {
      allow read: if true; // Público para validar antes do cadastro
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // Finanças das criadoras
    match /creator_financials/{creatorId} {
      allow read: if isAuthenticated() && request.auth.uid == creatorId;
      allow create: if isAuthenticated() && request.auth.uid == creatorId;
      allow update: if isAuthenticated() && request.auth.uid == creatorId;
      allow delete: if false;
    }
    
    // Destaques das criadoras
    match /creator-highlights/{highlightId} {
      allow read: if true; // Permitir visualização pública de destaques
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // Stories temporários das criadoras
    match /temporaryStories/{storyId} {
      allow read: if true; // Permitir visualização pública
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.creatorId == request.auth.uid ||
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['views', 'viewedBy'])
      );
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // Serviços das criadoras
    match /creator-services/{serviceId} {
      allow read: if true; // Público para visualizar serviços
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // Rastreamento de XP
    match /xp_tracking/{trackingId} {
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }
    
    // Templates de notificação
    match /notificationTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated();
    }
    
    // Assinaturas
    match /subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.creatorId);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.creatorId);
      allow delete: if false;
    }
    
    // Mensagens privadas
    match /messages/{messageId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.senderId;
      allow update: if false;
      allow delete: if false;
    }
  }
}
